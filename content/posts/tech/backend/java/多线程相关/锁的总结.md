---
title: "锁的总结"
date: 2016-04-20
draft: false
layout: posts
tags: ["Java","锁"]
cover: 
    image: "https://raw.githubusercontent.com/Leowuqunqun/img/master/image202305262230322.png"
---

# 带着问题找答案
## Q1：Java是怎么上的锁？
## Q2：有哪些锁？使用场景？

# 锁的原理梳理

# 锁的脑图

# ![image.png](https://raw.githubusercontent.com/Leowuqunqun/img/master/image202305262230322.png)

## 宏观分类（乐观锁vs悲观锁）
**只是一种设计思想，并不是真的有一种锁叫乐观锁或者悲观锁**
### 乐观锁-读多写少
乐观锁是一种乐观思想，即认为**读多写少**，遇到并发写的可能性低，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据，采取在写时先读出当前版本号，然后加锁操作（比较跟上一次的版本号，如果一样则更新），如果失败则要重复读-比较-写的操作。
java中的乐观锁基本都是通过使用无锁编程实现的，最常用的是CAS算法，CAS是一种更新的原子操作，比较当前值跟传入值是否一样，一样则更新，否则失败。
#### CAS算法
CAS全称 Compare And Swap（比较与交换），是一种无锁算法。在不使用锁（没有线程被阻塞）的情况下实现多线程之间的变量同步。java.util.concurrent包中的原子类就是通过CAS来实现了乐观锁。
Java 并没有直接实现 CAS，CAS 相关的实现是通过 C++ 内联汇编的形式实现的。Java 代码需通过 JNI 才能调用。
CAS 是一条 CPU 的原子指令（cmpxchg指令），不会造成所谓的数据不一致问题，Unsafe 提供的 CAS 方法（如compareAndSwapXXX）底层实现即为 CPU 指令 cmpxchg

CAS算法涉及到三个操作数：

- 需要读写的内存值 V。
- 进行比较的值 A。
- 要写入的新值 B。

##### ABA问题
CAS需要在操作值的时候检查内存值是否发生变化，没有发生变化才会更新内存值。但是如果内存值原来是A，后来变成了B，然后又变成了A，那么CAS进行检查时会发现值没有发生变化，但是实际上是有变化的。ABA问题的解决思路就是在变量前面添加版本号，每次变量更新的时候都把版本号加一，这样变化过程就从“A－B－A”变成了“1A－2B－3A”。

解决方案

- JDK从1.5开始提供了AtomicStampedReference类来解决ABA问题，具体操作封装在compareAndSet()中。compareAndSet()首先检查当前引用和当前标志与预期引用和预期标志是否相等，如果都相等，则以原子方式将引用值和标志的值设置为给定的更新值。
##### 循环时间长开销大
如果CAS操作失败，就需要循环进行CAS操作(循环同时将期望值更新为最新的)，如果长时间都不成功的话，那么会造成CPU极大的开销。

解决方案

-  限制自旋次数，防止进入死循环。
##### 只能保证一个共享变量的原子操作
对一个共享变量执行操作时，CAS能够保证原子操作，但是对多个共享变量操作时，CAS是无法保证操作的原子性的。

解决方法

- Java从1.5开始JDK提供了AtomicReference类来保证引用对象之间的原子性，可以把多个变量放在一个对象里来进行CAS操作。
### 悲观锁-写多
悲观锁是就是悲观思想，即认为**写多**，遇到并发写的可能性高，每次去拿数据的时候都认为别人会修改，所以每次在读写数据的时候都会上锁，这样别人想读写这个数据就会block直到拿到锁。java中的悲观锁就是synchronized关键字和Lock的实现类，AQS框架下的锁则是先尝试cas乐观锁去获取锁，获取不到，才会转换为悲观锁，如ReentrantLock。
![image.png](https://raw.githubusercontent.com/Leowuqunqun/img/master/image202305262230219.png)

# 参考
[https://juejin.cn/post/6844903558937051144](https://juejin.cn/post/6844903558937051144)
[https://juejin.cn/post/6844903796636663815](https://juejin.cn/post/6844903796636663815)
[https://www.cnblogs.com/huansky/p/15746624.html](https://www.cnblogs.com/huansky/p/15746624.html)
[https://tech.meituan.com/2018/11/15/java-lock.html](https://tech.meituan.com/2018/11/15/java-lock.html)

