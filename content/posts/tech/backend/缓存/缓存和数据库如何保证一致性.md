---
title: "缓存和数据库如何保证一致性"
date: 2018-03-05
draft: false
layout: posts
tags: ["一致性","缓存"]
---

> 凡是处于不同物理位置的两个操作，如果操作的是相同数据，都会遇到一致性问题

当数据发生更新时，我们不仅要操作数据库，还要一并操作缓存。

- 更新数据库 + 删除缓存方案，在「并发」场景下无法保证缓存和数据一致性，解决方案是加「分布锁」，但这种方案存在「缓存资源浪费」和「机器性能浪费」的情况
- 采用「先删除缓存，再更新数据库」方案，在「并发」场景下依旧有不一致问题，解决方案是「延迟双删」，但这个延迟时间很难评估
- 采用「先更新数据库，再删除缓存」方案，为了保证两步都成功执行，需配合「消息队列」或「订阅变更日志」的方案来做，本质是通过「重试」的方式保证数据最终一致
- 采用「先更新数据库，再删除缓存」方案，「读写分离 + 主从库延迟」也会导致缓存和数据库不一致，缓解此问题的方案是「延迟双删」，凭借经验发送「延迟消息」到队列中，延迟删除缓存，同时也要控制主从库延迟，尽可能降低不一致发生的概率



